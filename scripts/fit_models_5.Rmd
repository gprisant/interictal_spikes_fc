---
title: "Do Interictal Discharges Affect iEEG Functional Connectivity"
output: html_document
author: Jennifer Stiso
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# clean workspace
rm(list=ls())

if (!require("pacman")) install.packages("pacman")
pacman::p_load(ggplot2, dplyr, lm.beta, RColorBrewer, nationalparkcolors, rjson, reticulate, gridExtra, wesanderson, MASS, outliers, lmerTest, stringr, lmPerm)

# set up python for later
use_python("/Users/stiso/anaconda3/bin/python") # path to python binary
py_config() # check it is using the specified version

# directory for RAM data, request from XXX
RAM_dir = '/Volumes/bassett-data/Jeni/RAM/'

# parameters
win = 1
detector = ''

```

## Functions
```{r}
get_beta <- function(d, ys, f) {
  # fit models for every given predictor
  for (y in ys){
    # remove nan rows
    d_lm = d[!is.na(d[y]),]
  
    # check if multiple sess and exper
    if (length(unique(d_lm$sess_exper)) > 1) {
      f_full <- paste(f, 'sess_exper', sep = ' + ')
      # to prevent prevent factor level errors
      d_lm$sess_exper = as.factor(d_lm$sess_exper)
    } else {
      f_full <- f
    }
    
    beta_bin_name <- paste(y, 'beta_bin', sep = '_')
    beta_num_name <- paste(y, 'beta_num', sep = '_')
    beta_spr_name <- paste(y, 'beta_spr', sep = '_')
    if (dim(d_lm[y])[1] == 0){ # check for nans
      d[beta_bin_name] <- NaN
      d[beta_num_name] <- NaN
      d[beta_spr_name] <- NaN
    } else {

      # make spike a factor - prevent factor level errors
      d_lm$bin_spike <- as.factor(d_lm$bin_spike)
      # for debugging
      # print(paste(y, d_lm$band[1], d_lm$fc_measure[1], d_lm$region[1]))
      
      # fit
      # check for singular matrix (only two values for spike_num)
      cor_check1 = cor.test(d_lm$spike_num, d_lm$spike_spread) 
      cor_check2 = cor.test(d_lm$spike_num, as.numeric(d_lm$bin_spike))
      if (cor_check1$estimate != 1 & cor_check2$estimate != 1){
        f_full = paste(y, f_full, sep = '')
        try({fit <- lmp(as.formula(f_full), d_lm, singular.ok = FALSE)
        d[beta_bin_name] <- fit$coefficients['bin_spike1']
        d[beta_num_name] <- fit$coefficients['spike_num']
        d[beta_spr_name] <- fit$coefficients['spike_spread']})
      } else if (cor_check1$estimate == 1 & cor_check2$estimate != 1){
        f_full <- str_remove(f_full, fixed("+ spike_spread"))
        f_full = paste(y, f_full, sep = '')
        try({fit <- lmp(as.formula(f_full), d_lm, singular.ok = FALSE)
        d[beta_bin_name] <- fit$coefficients['bin_spike1']
        d[beta_num_name] <- fit$coefficients['spike_num']
        d[beta_spr_name] <- NaN})
      } else if (cor_check2$estimate == 1 & cor_check1$estimate != 1){
        f_full <- str_remove(f_full, fixed("+ bin_spike"))
        f_full = paste(y, f_full, sep = '')
        try({fit <- lmp(as.formula(f_full), d_lm, singular.ok = FALSE)
        d[beta_spr_name] <- fit$coefficients['spike_spread']
        d[beta_num_name] <- fit$coefficients['spike_num']
        d[beta_bin_name] <- NaN})
      } else {
        f_full <- str_remove(f_full, fixed("+ spike_num + spike_spread"))
        f_full = paste(y, f_full, sep = '')
        try({fit <- lmp(as.formula(f_full), d_lm, singular.ok = FALSE)
        d[beta_bin_name] <- fit$coefficients['bin_spike1']
        d[beta_num_name] <- NaN
        d[beta_spr_name] <- NaN})
      }
    }
  }
  return(d)
  flush.console()
}
```

# Methods

words

## Load Data

```{r}
# get subjects from all releases
releases <- c('1', '2', '3')
subj <- list()
for (r in releases){
  curr_info <- paste(RAM_dir, 'release', r, '/protocols/r1.json', sep='')
  df <- rjson::fromJSON(file = curr_info)
  df <- names(df$protocols$r1$subjects) %>%
    lapply(function(x){paste('release', r, '/r1/', x, sep ='')})
  subj <- append(subj, df)
}

```

## Fit Models

```{r, echo=FALSE,results=FALSE}
# Do we want to make plots? faster if no
save_plot = FALSE

# intiialize, make constants
# constant fields
const_vars <- c('subj', 'hand', 'age', 'gender', 'race')
form <- ' ~ power + bin_spike + spike_num + spike_spread'
ys = c('str', 'str_soz', 'str_not_soz', 'str_spike', 'str_not_spike', "ti")

# final df
col_names <- c("fc_measure", "band", 'band_measure', "str_beta_bin", "str_beta_num", "str_beta_spr", "ti_beta_bin", "ti_beta_num", "ti_beta_spr", "subj", "hand", "age", "gender", "race", 'n_tp')
net_betas <- data.frame(matrix(ncol = length(col_names), nrow = 0))
colnames(net_betas) = col_names
col_names = c("subj", "fc_measure", "band", 'band_measure', "str_soz_beta_bin", "str_not_soz_beta_bin", "str_spike_beta_bin", 
              "str_not_spike_beta_bin","str_soz_beta_num", "str_not_soz_beta_num", "str_spike_beta_num","str_soz_beta_spr","str_not_soz_beta_spr","str_spike_beta_spr", "str_not_spike_beta_spr", 'x', 'y', 'z', 'type',
              "str_not_spike_beta_num", "elec", "region", "n_tp", "elec_in_soz", "elec_spike", "age", "gender", "race", "hand" )
node_betas <- data.frame(matrix(ncol = length(col_names), nrow = 0))
colnames(node_betas) = col_names

# for each subject, load their data and fit some models
for (s in subj){
  # load strengths from matlab
  curr_csv <- paste(RAM_dir, 'FC/', s, '/win_', as.character(win), '/fc_data', detector, '.csv', sep = '')
  if (file.exists(curr_csv) ){
    node_data <- read.csv(curr_csv, header = TRUE, sep = ",", stringsAsFactors = FALSE,
                          colClasses=c(gender='character', hand='character', race='numeric', age='numeric', spike_num='numeric'))
    if (dim(node_data)[1] > 0){
      message(paste('Subj', s)) 
      # add band measure, combined string, for easy indexing (keep separate for plotting)
      node_data <- mutate(node_data, band_measure = paste(band, fc_measure, sep = '_'))
      # add sess_exper for model, dont actually want to model them separately
      node_data <- mutate(node_data, sess_exper = paste(sess, exper, sep = '_'))
      # add binary spike
      node_data$bin_spike = node_data$spike_num > 0
      # there shouldn't be any negative numbers, but if there are skip
      if (any(node_data$spike_num[complete.cases(node_data$spike_num)] < 0)){
        node_data$spike_num[node_data$spike_num < 0] = NaN
        warning("This dataset had negative spike numbers: check the spreadsheet")
        next
      }
      # there shouldn't be any NaNs, but if there are skip
      if (any(is.nan(node_data$spike_num)) | any(is.na(node_data$spike_num))){
        warning("This dataset had NaN spike numbers: check the spreadsheet")
        next
      }
      
      # drop hg phase locking - PLV not interpretable for wide band signals
      node_data <- filter(node_data, band_measure != "hg_plv")
      # remove duplicate time points, if present
      node_data <- node_data %>% distinct()
      
      # get network level strength separated by soz and not soz
      net_data <- group_by(node_data, sess_exper, time, spike_num, spike_spread, bin_spike, fc_measure, band, band_measure) %>%
        dplyr::summarise(str = mean(str, na.rm=TRUE), str_spike = mean(str_spike, na.rm=TRUE), 
                         str_not_spike = mean(str_not_spike, na.rm=TRUE), ti = mean(ti, na.rm=TRUE),  power = mean(power))
      # for soz networks, you can't average over all elecs, have to break them up
      tmp_soz = group_by(node_data, elec_in_soz, sess_exper, time, spike_num, bin_spike, spike_spread, fc_measure, band, band_measure) %>%
        dplyr::summarise(str_soz = mean(str_soz, na.rm=TRUE), str_not_soz = mean(str_not_soz, na.rm=TRUE))
      # remove not soz elecs from str_soz, and visa versa
      tmp_soz$str_soz[tmp_soz$elec_in_soz == 0] <- NA
      tmp_soz$str_not_soz[tmp_soz$elec_in_soz == 1] <- NA
      # now colapse over elec_in_soz
      tmp_soz <- group_by(node_data, sess_exper, time, spike_num, spike_spread, bin_spike, fc_measure, band, band_measure) %>%
        dplyr::summarise(str_soz = mean(str_soz, na.rm=TRUE), str_not_soz = mean(str_not_soz, na.rm=TRUE))
      # now merge on shared features (subj, band, time, etc)
      net_data = merge(net_data, tmp_soz, by = c('sess_exper', 'time', 'spike_num','spike_spread', 'bin_spike', "fc_measure", 'band', 'band_measure'))
      
      # add constants
      net_data[const_vars] = node_data[const_vars][1,]
      
      # plots
      if (save_plot){
          p1 <- ggplot(data=net_data[net_data$spike_num != 0,], aes(x=spike_num)) + geom_histogram() + theme_minimal()
          p2 <-ggplot(data=net_data[net_data$spike_spread != 0,], aes(x=spike_spread)) + geom_histogram() + theme_minimal()
          p3 <- ggplot(data=net_data[net_data$spike_num != 0,], aes(x=str, color=band, fill=as.factor(fc_measure))) + 
            geom_histogram(alpha=0.7) + theme_minimal() + scale_fill_manual(values=park_palette("GeneralGrant")) + scale_color_grey()
          p <- grid.arrange(p1, p2, p3, nrow=3)
          ggsave(paste(RAM_dir, 'img/models/', net_data$subj, '_net_hist.png', sep=''), plot=p, device = 'png')
      }
    
      # for every fc_meansure and band, fit network model
      try({
        curr_net_beta <- group_by(net_data, band_measure) %>%
          group_modify(~ get_beta(.x,ys, form)) %>%
          dplyr::summarise(n_tp = length(time), str_beta_bin = str_beta_bin[1], str_beta_num = 
                             str_beta_num[1], str_beta_spr = str_beta_spr[1], ti_beta_bin = 
                             ti_beta_bin[1], ti_beta_num = ti_beta_num[1], ti_beta_spr = ti_beta_spr[1], 
                           str_soz_beta_bin = str_soz_beta_bin[1],  str_soz_beta_num = 
                             str_soz_beta_num[1], str_soz_beta_spr = str_soz_beta_spr[1], 
                           str_not_soz_beta_num = str_not_soz_beta_num[1], str_spike_beta_num = 
                             str_spike_beta_num[1], str_not_soz_beta_spr = 
                             str_not_soz_beta_spr[1],str_not_soz_beta_bin = str_not_soz_beta_bin[1], 
                           str_spike_beta_bin = str_spike_beta_bin[1], str_spike_beta_spr = 
                             str_spike_beta_spr[1],str_not_spike_beta_bin = 
                             str_not_spike_beta_bin[1],fc_measure = fc_measure[1], str_not_spike_beta_num
                           = str_not_spike_beta_num[1], str_not_spike_beta_spr = 
                             str_not_spike_beta_spr[1], band = band[1])
        curr_net_beta[const_vars] <- net_data[const_vars][1,]
        
        # concatenate
        net_betas <- suppressWarnings(bind_rows(curr_net_beta, net_betas)) # silence warnings about converting factors to strings
      })
  
      # fit node models
      try({
          curr_node_beta <- group_by(node_data, elec, band_measure) %>%
              group_modify(~ get_beta(.x,ys, form)) %>%
              dplyr::summarise(n_tp = length(time), elec_spike = mean(elec_has_spike), 
                               elec_in_soz = elec_in_soz[1], str_soz_beta_bin = str_soz_beta_bin[1], 
                               str_not_soz_beta_bin = str_not_soz_beta_bin[1], str_spike_beta_bin = 
                                 str_spike_beta_bin[1], str_not_spike_beta_bin = 
                                 str_not_spike_beta_bin[1], str_beta_bin = str_beta_bin[1], 
                               str_soz_beta_num = str_soz_beta_num[1], str_not_soz_beta_num = 
                                 str_not_soz_beta_num[1], str_spike_beta_num = str_spike_beta_num[1], 
                               str_beta_num = str_beta_num[1],str_not_spike_beta_num = 
                                 str_not_spike_beta_num[1], ti_beta_bin = ti_beta_bin[1], ti_beta_num = 
                                 ti_beta_num[1], ti_beta_spr = ti_beta_spr[1], str_beta_spr = 
                                 str_beta_spr[1], str_soz_beta_spr = str_soz_beta_spr[1], 
                               str_not_soz_beta_spr = str_not_soz_beta_spr[1], str_spike_beta_spr = 
                                 str_spike_beta_spr[1], str_not_spike_beta_spr = 
                                 str_not_spike_beta_spr[1], fc_measure = 
                                 fc_measure[1], band = band[1], region = region[1], x = x[1],
                               y = y[1], z = z[1], type = type[1])
            curr_node_beta[const_vars] <- net_data[const_vars][1,]
            
          #  concetenate
          node_betas <- suppressWarnings(bind_rows(curr_node_beta, node_betas)) # silence warnings about converting factors to strings
        })
     }
  }
}

# save betas
write.csv(net_betas, file = paste(RAM_dir, 'group_analysis/win_', as.character(win), '/network_stats', detector, '.csv', sep=''))
write.csv(node_betas, file = paste(RAM_dir, 'group_analysis/win_', as.character(win), '/node_stats', detector, '.csv', sep=''))

```

